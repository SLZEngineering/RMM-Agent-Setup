#!/usr/bin/env bash
# ============================================================
# Solutionz INC RMM Agent Collector Connection Check (Linux)
# System Admin: Seneathia Williams
# Last Updated: 2026-02-17
# Description: Validates outbound connectivity to Domotz cloud endpoints and
#              related services. Output format mirrors expected "Step 2" results.
#
# FIX INCLUDED:
# - Ensures required tools (nc, curl, openssl) are present
# - Always prints output even when non-interactive (tee/systemd)
# - Generates a timestamped log file automatically
#
# Logs:
# - <home>/rmm_logs/rmm_collector_check_<timestamp>.log
# ============================================================

set -euo pipefail

# Re-run as root if needed (for optional tool install)
if [[ "${EUID}" -ne 0 ]]; then
  exec sudo bash "$0" "$@"
fi

RUN_USER="${SUDO_USER:-${USER}}"
RUN_HOME="$(eval echo "~${RUN_USER}")"
LOG_DIR="${RUN_HOME}/rmm_logs"
TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="${LOG_DIR}/rmm_collector_check_${TS}.log"

mkdir -p "${LOG_DIR}"
exec > >(tee -a "${LOG_FILE}") 2>&1

# -------- helpers --------
hdr() { echo -e "\n*--- $1 ---"; }

dns_line() {
  local host="$1"
  if getent hosts "$host" >/dev/null 2>&1; then
    echo "$host - DNS RESOLVED"
    return 0
  else
    echo "$host - DNS FAILED"
    return 1
  fi
}

icmp_line() {
  local host="$1"
  if ping -c 1 -W 2 "$host" >/dev/null 2>&1; then
    echo "$host - ICMP REACHABLE"
    return 0
  else
    echo "$host - ICMP UNREACHABLE"
    return 1
  fi
}

tcp_open_closed_line() {
  local host="$1" port="$2"
  # Runs nc and then prints "host:port - TCP OPEN/CLOSED"
  if nc -zvw5 "$host" "$port" >/dev/null 2>&1; then
    echo "$host:$port - TCP OPEN"
    return 0
  else
    echo "$host:$port - TCP CLOSED"
    return 1
  fi
}

tcp_nc_verbose() {
  local host="$1" port="$2"
  # Print nc's standard verbose line (the one with "Connection to ... succeeded!")
  # We do NOT suppress stderr because nc prints its useful message there.
  nc -zvw5 "$host" "$port" || true
}

ssl_valid_line() {
  local host="$1"
  # Validate TLS cert chain (prints a single PASS/FAIL style line to match expected)
  if openssl s_client -connect "${host}:443" -servername "${host}" -verify_return_error </dev/null 2>&1 | grep -q "Verify return code: 0 (ok)"; then
    echo "${host} - SSL VALID"
  else
    echo "${host} - SSL INVALID"
  fi
}


http_success_line() {
  local labelhost="$1" url="$2"
  # Expected output shows "2000.portal.domotz.com - HTTP SUCCESS"
  if curl -fsS --connect-timeout 5 -m 8 -I "$url" >/dev/null 2>&1; then
    echo "$labelhost - HTTP SUCCESS"
  else
    echo "$labelhost - HTTP FAILED"
  fi
}

ensure_tools() {
  # netcat line format must match expected ("Connection to ... succeeded!")
  if ! command -v nc >/dev/null 2>&1; then
    apt-get update -y
    apt-get install -y netcat-openbsd
  fi
  if ! command -v curl >/dev/null 2>&1; then
    apt-get update -y
    apt-get install -y curl
  fi
  if ! command -v openssl >/dev/null 2>&1; then
    apt-get update -y
    apt-get install -y openssl
  fi
}

main() {
  echo "Step 2: Verify Results:"
  echo "Log file: $LOG_FILE"
  ensure_tools

  hdr "GENERAL CONNECTIVITY"
  dns_line "portal.domotz.com" || true
  http_success_line "2000.portal.domotz.com" "https://portal.domotz.com" || true
  ssl_valid_line "portal.domotz.com" || true
  tcp_nc_verbose "portal.domotz.com" 443
  tcp_open_closed_line "portal.domotz.com" 443 || true

  dns_line "echo.domotz.com" || true
  icmp_line "echo.domotz.com" || true

  hdr "API CONNECTIVITY"
  tcp_nc_verbose "api-us-east-1-cell-1.domotz.com" 443
  tcp_open_closed_line "api-us-east-1-cell-1.domotz.com" 443 || true
  tcp_nc_verbose "api-eu-west-1-cell-1.domotz.com" 443
  tcp_open_closed_line "api-eu-west-1-cell-1.domotz.com" 443 || true

  hdr "MESSAGING SERVICES"
  tcp_nc_verbose "messaging-us-east-1-cell-1.domotz.com" 5671
  tcp_open_closed_line "messaging-us-east-1-cell-1.domotz.com" 5671 || true
  tcp_nc_verbose "messaging-eu-west-1-cell-1.domotz.com" 5671
  tcp_open_closed_line "messaging-eu-west-1-cell-1.domotz.com" 5671 || true

  hdr "REMOTE CONNECTIONS"
  # NOTE: The expectation from the reference output is primarily ICMP REACHABLE on these hosts.
  # TCP ports may show "failed: Connection refused" or "timed out" depending on upstream behavior.
  for host in sshg.domotz.co us-east-1-sshg.domotz.co us-east-1-02-sshg.domotz.co us-west-2-sshg.domotz.co ap-southeast-2-sshg.domotz.co; do
    icmp_line "$host" || true
    for port in 32700 40000 50000 57699; do
      tcp_nc_verbose "$host" "$port"
      tcp_open_closed_line "$host" "$port" || true
    done
    echo
  done

  hdr "PROVISIONING CHANNEL"
  tcp_nc_verbose "provisioning.domotz.com" 4505
  tcp_open_closed_line "provisioning.domotz.com" 4505 || true
  tcp_nc_verbose "provisioning.domotz.com" 4506
  tcp_open_closed_line "provisioning.domotz.com" 4506 || true

  tcp_nc_verbose "login.ubuntu.com" 443
  tcp_open_closed_line "login.ubuntu.com" 443 || true

  # Often seen in expected output (SKS keyserver). Not required for Domotz, but included for parity.
  tcp_open_closed_line "pool.sks-keyservers.net" 11371 || true

  tcp_nc_verbose "messaging.orchestration.domotz.com" 5671
  tcp_open_closed_line "messaging.orchestration.domotz.com" 5671 || true

  tcp_nc_verbose "api.orchestration.wl-pro.com" 443
  tcp_open_closed_line "api.orchestration.wl-pro.com" 443 || true

  tcp_nc_verbose "tunny.domotz.org" 55022
  tcp_open_closed_line "tunny.domotz.org" 55022 || true

  hdr "UPDATES FROM CANONICAL"
  for host in api.snapcraft.io serial-vault-partners.canonical.com storage.snapcraftcontent.com canonical-lgw01.cdn.snapcraftcontent.com canonical-lcy01.cdn.snapcraftcontent.com canonical-lcy02.cdn.snapcraftcontent.com canonical-bos01.cdn.snapcraftcontent.com upload.apps.ubuntu.com; do
    tcp_open_closed_line "$host" 443 || true
  done

  hdr "HTTPS SERVERS, NTP SERVERS, SPEEDTEST SERVICES"
  # HTTPS
  for host in www.google.com www.fast.com www.canonical.com www.redhat.com api.fast.com ichnaea-web.netflix.com api.ipify.org ipapi.co icanhazip.com; do
    tcp_open_closed_line "$host" 443 || true
  done
  # NTP (best-effort, UDP; we just show DNS resolution here)
  for host in ntp.ubuntu.com 0.pool.ntp.org 1.pool.ntp.org; do
    dns_line "$host" || true
  done

  echo -e "\nComplete. Log saved: $LOG_FILE"
}

main "$@"
